<!doctype html>
<html lang="en">

<head>
  <title>Word Cloud Left/Right</title>
  <script src="http://d3js.org/d3.v7.min.js" charset="utf-8"></script>

  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS v5.2.1 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">

</head>

<body>

  <header>
    <div class="row justify-content-center display-1 mt-4 ms-4 p-1">Media Analysis Project  
    </div>

    <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
      <div class="container-fluid">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link active" href="#">Link 1</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Link 2</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Link 3</a>
          </li>
        </ul>
      </div>
        </nav>
  </header>
  <main>
    <div class="container-lg mt-5">
      <div class="row">
         <div class="row align-items-start display-2">Ordered Word Clouds
             <div class="col-8">
             <p class="lead">This page allows you to pick a week and displays word cloud visuals of the left and right 
             wings to illustrate what types of topics may be trending.</p>
             <p class="lead">Please enter in a Sunday start date between August 2022 and today:</p>
             </div>
         </div>
       </div>
     </div>
 
    <form class="container-lg" id="form">
      <div class="mb-3">
        <label for="StartDate">Start date:</label>
        <input id="startDate" type="date">
        <button type = "button" class="btn btn-primary" onclick="setWeek()">Create Word Cloud!</button>
        <p id = "day"></p>
      </div>
    </form> 

    <script>
    // getting user input for week, format to match dates in CSV file names 
    config = import('./config.js/')
        
    function setWeek() {
      var day = new Date(document.getElementById("startDate").value);
      var one = 1;
      var dateCSV = new Date(day.setDate(day.getDate() + one))
        .toLocaleDateString('en-GB')
        .split('/')
        .reverse()
        .join('');
      console.log(dateCSV)
    

    leftCSV = ''.concat(dateCSV + '-top-left.csv');
    rightCSV = ''.concat(dateCSV + '-top-right.csv'); 
    console.log(leftCSV)
    console.log(rightCSV)
  
    var RightcsvData = Array.from(d3.csv(rightCSV).then(function(data) {
      console.log(data);
    }));
    var LeftcsvData = Array.from(d3.csv(leftCSV).then(function(data) {
      console.log(data);
    }));

    const cleanedRightData = RightcsvData 
        .filter(r => r.term.length > 2)
        .sort((x, y) => d3.descending(x.count, y.count))
        .slice(0, config.maxTerms)

    const rightTotal = cleanedRightData.map(r => r.count).reduce((a, b) => a + b, 0)


    // clean data from arrays 
    const rightData = [
      cleanedRightData, rightTotal,
      cleanedRightData.map(r => ({ ...r, tfnorm: r.count/total }))
    ]

    const cleanedLeftData = LeftcsvData
        .filter(r => r.term.length > 2)
        .sort((x, y) => d3.descending(x.count, y.count))
        .slice(0, config.maxTerms)

    const leftTotal = cleanedLeftData.map(r => r.count).reduce((a, b) => a + b, 0)

    const leftData = [
      cleanedLeftData, leftTotal,
      cleanedLeftData.map(r => ({ ...r, tfnorm: r.count/total }))
    ]

    const added = leftData.concat(rightData)

    var extent = d3.extent(added, d => d.tfnorm)


    function test() {
        const totalWidth = 1200;

        // first split the data into left/both/right
        const totalCount = leftData.map(r => r.count).reduce((a, b) => a + b, 0) 
                          + rightData.map(r => r.count).reduce((a, b) => a + b, 0);
        
        // figure out venn diagram overlap
        let leftTerms = leftData.map(d => d.term);
        let rightTerms = rightData.map(d => d.term);
        const bothTerms = leftTerms.filter(t => rightTerms.includes(t));
        leftTerms = leftTerms.filter(t => !bothTerms.includes(t));
        rightTerms = rightTerms.filter(t => !bothTerms.includes(t));
        
        // re-normalize split data
        const left = leftData.filter(d => leftTerms.includes(d.term)).map(d => ({...d, tfnorm:d.count/totalCount}));
        const right = rightData.filter(d => rightTerms.includes(d.term)).map(d => ({...d, tfnorm:d.count/totalCount}));
        const both = bothTerms.map(t => {
          const leftItem = leftData.find(i => i.term == t);
          const rightItem = rightData.find(i => i.term == t);
          return {'term': t, 'count': leftItem.count + rightItem.count, tfnorm: (leftItem.count + rightItem.count)/totalCount};
        })
        .sort((a,b) => a.count < b.count);

        // layout in 3 columns
        const svg = d3.create('svg')
          .attr('width', totalWidth)
          .attr('height', config.height);

        // titles
        const leftLabel = svg.append('g') // left
          .attr("transform", "translate(0,20)")
        leftLabel.append('line')
            .style("stroke", "#333333")
            .style("stroke-width", 1)
            .attr("x1", 0)
            .attr("y1", 10)
            .attr("x2", totalWidth/3 - 20)
            .attr("y2", 10);
        leftLabel.append("text")
            .attr("fill", '#333333')
            .attr("font-weight", 900)
            .attr("font-size", "16px")
            .text("Top Terms Unique to Left-Leaning Media");
        const bothLabel = svg.append('g') // both
          .attr("transform", "translate("+totalWidth/3+",20)")
        bothLabel.append('line')
            .style("stroke", "#333333")
            .style("stroke-width", 1)
            .attr("x1", 0)
            .attr("y1", 10)
            .attr("x2", totalWidth/3 - 20)
            .attr("y2", 10);
        bothLabel.append("text")
            .attr("fill", '#333333')
            .attr("font-weight", 900)
            .attr("font-size", "16px")
            .text("Top Terms in Both Left and Right Leaning Media");
        const rightLabel = svg.append('g') // left
          .attr("transform", "translate("+2*(totalWidth/3)+",20)")
        rightLabel.append('line')
            .style("stroke", "#333333")
            .style("stroke-width", 1)
            .attr("x1", 0)
            .attr("y1", 10)
            .attr("x2", totalWidth/3 - 20)
            .attr("y2", 10);
        rightLabel.append("text")
            .attr("fill", '#333333')
            .attr("font-weight", 900)
            .attr("font-size", "16px")
            .text("Top Terms Unique to Right-Leaning Media");
        
            // word cloud
        svg.append('g') // left
          .attr("transform", "translate(0,35)")
          .node().appendChild(orderedWordCloud(totalWidth/3, left, '#333399', extent, 'left-top'));
        svg.append("g") // both
          .attr("transform", "translate(" + totalWidth/3 + ",35)")
          .node().appendChild(orderedWordCloud(totalWidth/3, both, '#800080', extent, 'both-top'));
        svg.append('g') // right
          .attr("transform", "translate(" + 2*(totalWidth/3) + ",35)")
          .node().appendChild(orderedWordCloud(totalWidth/3, right, '#993333', extent, 'right-top'));
        return svg.node();
    }}
    

    </script>

    <div class="container-xxl mt-5">
      <div class="row">
        <div class="col-6">
          <h2>Top Terms Unique to Left-Leaning Media</h2>
            <div class="p-5 border">Insert viz</div>
              </div>
              <div class="col-6">
                <h2>Top Terms Unique to Right-Leaning Media</h2>
                  <div class="p-5 border">Insert viz</div>
             </div>
         </div>
     </div>
  </main>
  <footer>
    <!-- place footer here -->
  </footer>
  <!-- Bootstrap JavaScript Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
    integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous">
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.min.js"
    integrity="sha384-7VPbUDkoPSGFnVtYi0QogXtr74QeVeeIs99Qfg5YCF+TidwNdjvaKZX19NZ/e6oz" crossorigin="anonymous">
  </script>
</body>
</html> 
